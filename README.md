# Information
This Python script automatically blocks malicious IP addresses detected by Elastic Security alerts.
It connects to Elasticsearch, retrieves alerts generated by a specific detection rule, extracts the attackerâ€™s source IP address, and then creates a firewall rule using UFW to block further SSH access from that IP.

When the script starts, it first loads a list of already blocked IP addresses from a local file (`blocked_ips.txt`).
This prevents duplicate firewall rules from being created and ensures the script only blocks new attackers.

It also reads a state file (`last_run.txt`) which stores the timestamp of the previous execution.
This allows the script to query Elasticsearch only for alerts that were generated after the last run, instead of processing all historical alerts every time.

Next, the script establishes a connection to Elasticsearch using the Python Elasticsearch client and authenticates with the configured credentials.

It then searches the Elastic Security alerts index for alerts created by the rule:

">3 Failed SSH logon attempts in 5 minutes". This is a CUSTOM RULE, its not in elastic by default. You can just change the Name in the script to any rule you'd like. You can also use Rule ID or any other field that you like.

Only alerts newer than the last execution time are retrieved.

For each alert found, the script extracts the `source.ip` field from the alert document.
If the IP address exists and is not already in the block list, the script inserts a new UFW rule to deny incoming SSH connections (port 22) from that IP address.

The rule is inserted before the general SSH allow rule so that the deny rule takes precedence in the firewall rule order.

After successfully blocking the IP, the script records the IP address and the current timestamp in `blocked_ips.txt`.
This ensures the same IP will not be blocked again in future runs.

At the end the script updates the `last_run.txt` file with the current timestamp so that the next execution only processes new alerts.

This creates a simple automated defense mechanism against SSH brute-force attacks detected by Elastic Security.

# Setup
Run the script
Setup

Clone the repository and install the dependencies:

git clone https://github.com/Dellou-git/elastic-ssh-multiple-logon-failures-rule---block-ip-via-ufw/edit/main/README.md
cd elastic-ssh-ip-blocker

python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

Configure credentials

Open ipblocker.py and set your Elasticsearch credentials:

USERNAME = "<Username>"
PASSWORD = "<Password>"


Make sure the following values match your environment:

Elasticsearch URL

Alerts index

Detection rule name

Run manually
sudo venv/bin/python ipblocker.py


Root privileges are required because the script modifies UFW firewall rules.

Verify blocking
sudo ufw status


Blocked IPs are stored in:

blocked_ips.txt


Each entry contains the IP address and the timestamp when it was blocked.

Python client major version == Elasticsearch major version
Elasticsearch	Python client
7.x	          elasticsearch<8
8.x	          elasticsearch<9
9.x	          elasticsearch>=9

And so on
